{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>

  {% block extra_css %}
  <!-- Primero, incluir la libreria de JpegCam -->
  <script src="/static/jpegcam/webcam.js"></script>
  {% endblock extra_css %}
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>KIT Online Examination System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="{% static 'css/test_management.css' %}" />
    <link rel="stylesheet" type="text/css" media="screen" href="{% static 'css/bootstrap-select.min.css' %}" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-rose">
    <img src="../static/img/kit-11.png" style="width: 8%; margin-left: 25px;">
    <div class="container">
        <div class="navbar-translate">
            <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
            </button>

        </div>
        <div class="collapse navbar-collapse" style="margin-left: 100px;"> 
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="{% url 'register' %}" class="nav-link"><b>Dashboard</b></a>
                </li>
                <li class="nav-item">
                    <a href="#Question" class="nav-link"><b>Question</b></a>
                </li>
                <li class="nav-item">
                    <a href="#Test" class="nav-link"><b>Test</b></a>
                </li>
                <li class="nav-item active">
                    <a href="#Candidate" class="nav-link"><b>Candidate</b></a>
                </li>
                <li class="nav-item">
                    <a href="#Live View" class="nav-link"><b>Live View</b></a>
                </li>
                <li class="nav-item">
                    <a href="#report" class="nav-link"><b>Reporting</b></a>
                </li>
            </ul>

            <form class="form-inline ml-auto">
                <div class="form-group has-white">
                  <input type="text" class="form-control" placeholder="Search">
                </div>
                <button type="submit" class="btn btn-white btn-raised btn-fab btn-fab-mini btn-round">
                    <i class="material-icons">search</i>
                </button>
            </form>
        </div>
    </div>
</nav>
  {% block test_list %}
  
  {% endblock %}
  {% block question_list %}
  {% endblock %}
  {% block import_question %}
  {% endblock %}

  <script src="{% static 'js/core/jquery.min.js' %}"></script>
  <script src="{% static 'js/core/popper.min.js' %}"></script>
  <script src="{% static 'js/core/bootstrap-material-design.min.js' %}"></script>
  <script src="{% static 'js/core/bootstrap-select.min.js' %}"></script>

</body>
<script type='text/javascript'>
$(document).ready(function(){
  // Check or Uncheck All checkboxes
  $("#checkall").change(function(){
    var checked = $(this).is(':checked');
    if(checked){
      $(".check-ele").each(function(){
        $(this).prop("checked",true);
      });
    }else{
      $(".check-ele").each(function(){
        $(this).prop("checked",false);
      });
    }
  });

  // Changing state of CheckAll checkbox 
  $(".check-ele").click(function(){

    if($(".check-ele").length == $(".check-ele:checked").length) {
      $("#checkall").prop("checked", true);
    } else {
      $("#checkall").removeAttr("checked");
    }
  });
 });

//**test_list.html SCRIPT**
//Add Button- Test
$(".submit-btn-test").click(function(){
  var test_name = JSON.stringify($("#add_test_name").val());
  var test_type = JSON.stringify($("#add_test_type").val());
  var test_date = JSON.stringify($("#add_test_date").val());
  var button_pressed = JSON.stringify($(this).attr('name'));
  $.ajax({
    url: "{% url 'add_test' %}",
    type: 'POST',
    data: {'button_pressed' : button_pressed, 'test_name' : test_name, 'test_type' : test_type,
    'test_date' : test_date,'csrfmiddlewaretoken': $("[name=csrfmiddlewaretoken]").val()},
  })
  var button_pr = $(this).attr('name');
  if (button_pr == 'add_new'){
    $("#add_test_name").val("");
    $("#add_test_type").val("");
    $("#add_test_date").val("");
  } else {
    $("#add_test_name").val("");
    $("#add_test_type").val("");
    $("#add_test_date").val("");
    $(".cancel-btn-test").click();
  }
});

//Delete Button- Test
$(".delete-btn-test").click(function(){
  var selected_rows=[];

  $('.test-list').find('tr').each(function(){
    var row=$(this);
    if (row.find('input[type="checkbox"]').is(':checked')) {
        selected_rows.push(row.attr('data-id'));
        };
  });
  var selected_rows = JSON.stringify(selected_rows);
  $.ajax({
    url: "{% url 'delete_test' %}",
    type: 'POST',
    data: {'test_list_ids': selected_rows, 'csrfmiddlewaretoken': $("[name=csrfmiddlewaretoken]").val()},
    success: function(){
      location.reload();
    },
  });
});

//Edit OnClick- Test
$(".table-row td:not(:has(input))").click(function(){
  $('#editModal').modal('show');
  let rowId = $(this).closest('tr').attr('data-id');
  const row = $(this).closest('tr');
  var test_name = row.find('td[ name="test_name" ]').text();
  var test_type = row.find('td[ name="test_type" ]').text();
  var test_date = row.find('td[ name="test_date" ]').text();
  var date = new Date(test_date);
  var day = ("0" + date.getDate()).slice(-2);
  var month = ("0" + (date.getMonth() + 1)).slice(-2);
  var test_date = date.getFullYear()+"-"+(month)+"-"+(day) ;
  $('#edit_test_date').val(test_date);
  $("#edit_test_name").val(test_name);
  $("#edit_test_type").val(test_type);

  //EDIT FORM-- Save OnClick- Test
  $(".save-btn-test").click(function(){
    var row_id = JSON.stringify(rowId);
    var test_name = JSON.stringify($("#edit_test_name").val());
    var test_type = JSON.stringify($("#edit_test_type").val());
    var test_date = JSON.stringify($("#edit_test_date").val());
    $.ajax({
    url: "{% url 'edit_test' %}",
    type: 'POST',
    data: {'row_id' : row_id, 'test_name' : test_name, 'test_type' : test_type, 'test_date' : test_date,
            'csrfmiddlewaretoken': $("[name=csrfmiddlewaretoken]").val() },
    success: function(){
      location.reload();
      },
    });
  });
});

//**question_list.html SCRIPT**
//Add Button- Question
$(".submit-btn-question").on("click", (function(){
  var test_id = JSON.stringify($("#test_id").val());
  var question_type = JSON.stringify($("#question_type").val());
  var question_name = JSON.stringify($("#question_name").val());
  var button_pressed = JSON.stringify($(this).attr('name'));

  
  //Add option list into a dictionary `option_rows`
  var option_rows = {};
  var answer = "";
  $('.option-list tbody tr.option_row').each(function(){
    var option_name = "";
    var answer = "";
    option_name = $(this).find(".option-name").val();
    answer = $(this).find(".answer").val();
    option_rows[option_name] = answer;
    $(this).on("change", function(){
      var option_name = "";
      var answer = "";
      option_name = $(this).find(".option-name").val();
      answer = $(this).find(".answer").val();
      option_rows[option_name] = answer;
    });
  });
  var option_rows = JSON.stringify(option_rows);

  $.ajax({
    url: "{% url 'add_question' %}",
    type: 'POST',
    data: {'button_pressed' : button_pressed, 'question_name' : question_name, 'question_type' : question_type,
    'test_id' : test_id, 'option_rows' : option_rows,'csrfmiddlewaretoken': $("[name=csrfmiddlewaretoken]").val()},
  })
  
  var button_pr = $(this).attr('name');
  if (button_pr == 'add_new'){
    $("#test_id").val("");
    $("#question_type").val("");
    $("#question_name").val("");
  } else {
    $("#test_id").val("");
    $("#question_type").val("");
    $("#question_name").val("");
    $(".cancel-btn-question").click();
  }
}));

//Delete Button- Question
$(".delete-btn-question").click(function(){
  var selected_rows=[];

  $('.question-list').find('tr').each(function(){
    var row=$(this);
    if (row.find('input[type="checkbox"]').is(':checked')) {
        selected_rows.push(row.attr('data-id'));
        };
  });
  var selected_rows = JSON.stringify(selected_rows);
  $.ajax({
    url: "{% url 'delete_question' %}",
    type: 'POST',
    data: {'question_list_ids': selected_rows, 'csrfmiddlewaretoken': $("[name=csrfmiddlewaretoken]").val()},
    success: function(){
      location.reload();
    },
  });
});

//Edit OnClick- Question
$(".table-row td:not(:has(input))").on("click", function(){
  $('#editModal').modal('show');
  let rowId = $(this).closest('tr').attr('data-id');
  var test_name, question_type, question_name, option;

  $.ajax({
    url: "{% url 'edit_question' %}",
    type: 'GET',
    data: {"rowId" : rowId},
    dataType: 'json',
    success: function(data){
      test_name = data.question[0]['test_id'];
      question_name = data.question[0]['question_name'];
      question_type = data.question[0]['question_type'];
      if (question_type == 'QCM'){
        option_length = parseInt(data.question[1].length);
        options = data.question[1];
      }

      console.log(options, typeof(options));

      $(".question_name").val(question_name);
      $(".question_type").selectpicker('val', question_type);
      $(".test_id").selectpicker('val', test_name);

      jQuery.each(options, function(i, obj){
          $(".option_row").each(function(){
            $(".option-name").val(obj['option_name']);
            $(".answer").val(obj['answer']);
          });
          console.log(i, "+++", obj);
      });

      },
    });

      

  //EDIT FORM-- Save OnClick- Question
  $(".save-btn-question").click(function(){
    var row_id = JSON.stringify(rowId);
    var test_id = JSON.stringify($("#test_id").val());
    var question_type = JSON.stringify($("#question_type").val());
    var question_name = JSON.stringify($("#question_name").val());
    $.ajax({
    url: "{% url 'edit_question' %}",
    type: 'POST',
    data: {'row_id' : row_id, 'test_id' : test_id, 'question_type' : question_type, 'question_name' : question_name,
            'csrfmiddlewaretoken': $("[name=csrfmiddlewaretoken]").val() },
    success: function(){
      location.reload();
      },
    });
  });
});

//Add option row-- QCM
$("#add_option").click(function(){
  let add_option_row;
  if (add_option_row == null) {
    $.ajax({
      url: "{% url 'add_option_row' %}",
      type: 'GET',
      success: function(data){
        $('.option-list tr:nth-last-child(2)').after("<tr class='option_row'><td>"+data.substr(0,114)+"</td><td>"+data.substr(114,224)+"</td><td><i class='material-icons option-delete'>delete</i></td></tr>");
        $('.selectpicker').selectpicker('render');
      },
    });
  };
});

//OnChange if option = 'Essay', hide answer table
$("#question_type").change(function(){
  if($("#question_type").val() == 'ES'){
    $(".option-list").hide();
  }
  else{
    $(".option-list").show();
  }
});

//Delete option_row onClick
$('.option_row').on('click','td i',function(e){
   e.preventDefault();
   $(this).parents('tr').remove();
});


</script>
</html>